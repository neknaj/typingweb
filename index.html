<!DOCTYPE html>
<html>
    <head>
        <title>Neknaj Typing Web</title>
        <meta charset="utf*8">
        <meta property="og:title" content="Neknaj Typing Web">
        <meta property="og:description" content="typing software for web">
        <meta property="description" content="typing software for web">
        <link rel="stylesheet" href="layout.css">
        <script src="layout.js"></script>
        <script src="typing.js"></script>
        <script src="cdom.js"></script>
    </head>
    <body>
        <div class="resizer_Hcontainer" id="mainarea" data-proportion="5:2">
            <div class="resizer_content">
                <div class="resizer_Vcontainer" data-proportion="4:1">
                    <div class="resizer_content">
                        <div id="playArea">
                            <div id="Title"></div>
                            <div id="Ques"></div>
                            <div id="Input"></div>
                            <div id="Next"></div>
                        </div>
                    </div>
                    <div class="resizer_splitter"></div>
                    <div class="resizer_content">
                    </div>
                </div>
            </div>
            <div class="resizer_splitter"></div>
            <div class="resizer_content">
                <div class="resizer_Vcontainer" data-proportion="5:2">
                    <div class="resizer_content">
                        <div id="TypeHistory"></div>
                    </div>
                    <div class="resizer_splitter"></div>
                    <div class="resizer_content">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
<script>module={}</script>
<script src="./ntq.js"></script>
<script>const ntqparser = module.exports.parse;</script>
<script>

var typing;
var typingline;
var typingnextQues;
var status = "title";

window.onload = init;
async function init() {
    typing = loadntq("question/1.ntq");
    keyboard = JSON.parse(fRead("keyboard.json"))
    updateView();
};

function loadntq(filename) {
    const _data = fRead(filename).replace(/\r\n/g,"\n").split("\n");
    const res = {
        title: "",
        line: 0,
    }
    const lines = [];
    for (const i of _data) {
        console.log(i)
        if (i[0]=="#") {
            if (i.startsWith("#title ")) {res.title = i.slice(7)}
            continue;
        }
        lines.push(ntqparser(i));
    }
    for (const i of lines) {
        console.table(i.map((i)=>{return i.map((x)=>{if(x instanceof Array){return x.join(", ")};return x})}))
    }
    res.lines = lines;
    return res;
}


function fRead(filename) {
    var hr = new XMLHttpRequest();
    hr.open("GET", filename, false);
    hr.send(null);
    if (hr.status == 200 || hr.status == 304) {
        return hr.responseText.replace(/\r\n/g, "\n");
    }else {throw "err " + filename;}
};

function updateView() {
    Title.innerText = typing.title;
    if (status=="title") {
        Ques.replaceChildren(elm("span",{},[textelm("スペースを押して開始")]));
    }
    else if (status=="play") {
        Ques.replaceChildren(typingline.getQuesView());
        Input.replaceChildren(typingline.getInputView());
        Next.replaceChildren(typingnextQues);
    }
}

</script>
<script>

document.addEventListener("keydown",(e)=>{
    console.log("keydown",e.key)
    if (status=="title") {
        if (e.key==" ") {
            typing.line = 0;
            status = "play";
            typingline = new Typing(typing.lines[typing.line],keyboard);
            typingnextQues = new Typing(typing.lines[typing.line+1],keyboard).getQuesView();
            updateView();
        }
    }
    else if (status=="play") {
        var [key,endline] = typingline.key(e.key);
        console.log(key,endline);
        if (endline) {
            typing.line++;
            TypeHistory.appendChild(typingline.getInputView());
            if (typing.lines.length>typing.line) {
                typingline = new Typing(typing.lines[typing.line],keyboard);
                if (typing.lines.length>typing.line+1) {
                    typingnextQues = new Typing(typing.lines[typing.line+1],keyboard).getQuesView();
                }
                else {
                    Next.replaceChildren(elm("span",{},[textelm("end")]));
                }
            }
            else {
                status = "finish";
                Ques.replaceChildren(elm("span",{},[textelm("スペースを押してタイトルへ")]));
                Input.replaceChildren(elm("span",{},[]));
                Next.replaceChildren(elm("span",{},[]));
            }
        }
    }
    else if (status=="finish") {
        if (e.key==" ") {
            status = "title";
        }
    }
    updateView();
},false);


</script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@200&display=swap');
</style>
<style>
    * {
        user-select: none;
        font-family: "Noto Sans JP", sans-serif;
        font-optical-sizing: auto;
        font-style: normal;
        font-size: 110%;
    }
    body {
        background-color: rgb(0, 2, 10);
        color: white;
        position: fixed;
        padding: 0;
        margin: 0;
    }
    #imgOutArea {
        height: 100%;
        width: 100%;
        overflow: auto;
        position: relative;
        padding: 0;
        margin: 0;
    }
    #imgOutArea>canvas {
        cursor: crosshair;
        touch-action: none;
        position: absolute;
        left: 10px;
        top: 10px;
        transform-origin: top left;
        background-color: rgba(255, 255, 255, 0.3);
    }
    #mainarea {
        height: 100dvh;
        width: 100dvw;
    }
    
    #playArea {
        & #Ques {
            & rt {
                font-size: 20px;
                color: rgb(255, 255, 255);
                & .s1 {
                    color: rgb(255, 255, 255);
                }
                & .s2 {
                    color: rgb(255, 173, 173);
                }
                & .s3 {
                    color: rgb(164, 164, 255);
                }
                & .s4 {
                    color: rgb(255, 132, 132);
                }
            }
            & rb, & .noruby {
                font-size: 50px;
                color: rgb(255, 255, 255);
                &.s1 {
                    color: rgb(255, 255, 255);
                }
                &.s2 {
                    color: rgb(255, 173, 173);
                }
                &.s3 {
                    color: rgb(164, 164, 255);
                }
                &.s4 {
                    color: rgb(255, 132, 132);
                }
            }
        }
        & #Input span {
            font-size: 50px;
            color: rgb(255, 255, 255);
            &.s3 {
                color: rgb(164, 164, 255);
            }
            &.s4 {
                color: rgb(255, 132, 132);
            }
        }
    }
    
    #playArea {
        position: relative;
        height: 100%;
        font-size: 50px;
        &>div#Title {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
        }
        &>div#Ques {
            position: absolute;
            top: calc(50% - 50.5px + 5% - 70px);
            left: 40px;
            width: max-content;
        }
        &>div#Input {
            position: absolute;
            top: calc(50% - 50.5px + 5% + 70px);
            left: 40px;
            width: max-content;
        }
        &>div#Next {
            position: absolute;
            right: 40px;
            bottom: 10px;
            width: max-content;
            & rt {
                font-size: 15px;
            }
            & rb, & .noruby {
                font-size: 25px;
            }
        }
    }

    #TypeHistory {
        &>span {
            display: block;
        }
        span {
            font-size: 25px;
            color: rgb(255, 255, 255);
            &.s3 {
                color: rgb(164, 164, 255);
            }
            &.s4 {
                color: rgb(255, 132, 132);
            }
        }
    }
</style>