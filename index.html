<!DOCTYPE html>
<html>
    <head>
        <title>Neknaj Typing Web</title>
        <meta charset="utf-8">
        <meta property="og:title" content="Neknaj Typing Web">
        <meta property="og:description" content="typing software for web">
        <meta property="description" content="typing software for web">
        <link rel="stylesheet" href="layout.css">
        <script src="layout.js"></script>
        <script src="typing.js"></script>
        <script src="cdom.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
    </head>
    <body>
        <div class="resizer_Hcontainer" id="mainarea" data-proportion="5:2">
            <div class="resizer_content">
                <div class="resizer_Vcontainer" data-proportion="7:3">
                    <div class="resizer_content">
                        <div id="playArea">
                            <div id="Title"></div>
                            <div id="Ques"></div>
                            <div id="Input"></div>
                            <div id="Next"></div>
                        </div>
                    </div>
                    <div class="resizer_splitter"></div>
                    <div class="resizer_content" id="GraphArea">
                        <canvas id="TypingGraph"></canvas>
                    </div>
                </div>
            </div>
            <div class="resizer_splitter"></div>
            <div class="resizer_content">
                <div class="resizer_Vcontainer" data-proportion="5:2">
                    <div class="resizer_content">
                        <div id="TypeHistory"></div>
                    </div>
                    <div class="resizer_splitter"></div>
                    <div class="resizer_content">
                        <table style="width: 100%;height: 100%">
                            <tr>
                                <th>速さ</th>
                                <td id="Speed">0</td>
                                <td>type/s</td>
                            </tr>
                            <tr>
                                <th>精度</th>
                                <td id="Accuracy">0</td>
                                <td>%</td>
                            </tr>
                            <tr>
                                <th>時間</th>
                                <td id="Time">0</td>
                                <td>s</td>
                            </tr>
                            <tr>
                                <th>打鍵</th>
                                <td id="Typed">0</td>
                                <td>type</td>
                            </tr>
                            <tr>
                                <th>誤打</th>
                                <td id="Failed">0</td>
                                <td>type</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
<script>module={}</script>
<script src="./ntq.js"></script>
<script>const ntqparser = module.exports.parse;</script>
<script>

var typing;
var typingline;
var typingnextQues;
var typingchart;
var status = "title";

window.onload = init;
async function init() {
    typing = loadntq("question/1.ntq");
    keyboard = JSON.parse(fRead("keyboard.json"));
    typingnextQues = new Typing(typing.lines[typing.line],keyboard).getQuesView();
    updateView();
    makeChart();
};

function loadntq(filename) {
    const _data = fRead(filename).replace(/\r\n/g,"\n").split("\n");
    const res = {
        title: "",
        start: null,
        line: 0,
        type: 0,
        failed: 0,
    }
    const lines = [];
    for (const i of _data) {
        console.log(i)
        if (i[0]=="#") {
            if (i.startsWith("#title ")) {res.title = i.slice(7)}
            continue;
        }
        lines.push(ntqparser(i));
    }
    for (const i of lines) {
        console.table(i.map((i)=>{return i.map((x)=>{if(x instanceof Array){return x.join(", ")};return x})}))
    }
    res.lines = lines;
    return res;
}


function fRead(filename) {
    var hr = new XMLHttpRequest();
    hr.open("GET", filename, false);
    hr.send(null);
    if (hr.status == 200 || hr.status == 304) {
        return hr.responseText.replace(/\r\n/g, "\n");
    }else {throw "err " + filename;}
};

function updateView() {
    Title.innerText = typing.title;
    if (status=="title") {
        Next.replaceChildren(typingnextQues);
        Ques.replaceChildren(elm("span",{},[textelm("スペースを押して開始")]));
    }
    else if (status=="play") {
        Ques.replaceChildren(typingline.getQuesView());
        Input.replaceChildren(typingline.getInputView());
        Next.replaceChildren(typingnextQues);
        Time.innerText = (Date.now()-typing.start)/1000;
        Typed.innerText = typing.type;
        Failed.innerText = typing.failed;
        Speed.innerText = ((typing.type-typing.failed)/((Date.now()-typing.start)/1000)).toString().slice(0,5);
        Accuracy.innerText = ((typing.type-typing.failed)/typing.type*100).toString().slice(0,5);
    }
    { // chart size
        let rect = GraphArea.getBoundingClientRect();
        if (TypingGraph.width!=rect.width||TypingGraph.height!=rect.height) {
            TypingGraph.setAttribute("width",rect.width);
            TypingGraph.setAttribute("height",rect.height);
            typingchart.update();
            console.log("a")
        }
    }
}

function makeChart() {
    typingchart = new Chart(TypingGraph,{type:"line",data:{labels:[],datasets:[
        {
            label: "total speed",
            data: [],
            borderColor: "rgba(255,100,255,1)",
        },
        {
            label: "moment speed",
            data: [],
            borderColor: "rgba(100,255,255,1)",
        }
    ]}});
}

setInterval(updateView,100);

</script>
<script>

document.addEventListener("keydown",(e)=>{
    console.log("keydown",e.key)
    if (status=="title") {
        if (e.key==" ") {
            typing.line = 0;
            status = "play";
            typingline = new Typing(typing.lines[typing.line],keyboard);
            typingnextQues = new Typing(typing.lines[typing.line+1],keyboard).getQuesView();
            typing.start = Date.now();
            TypeHistory.replaceChildren(elm("span",{},[]));
            makeChart();
            updateView();
        }
    }
    else if (status=="play") {
        var [key,endline] = typingline.key(e.key);
        typing.type++;
        if (key==false) {
            typing.failed++;
        }
        if (key) { // graph
            typingchart.data.labels.push((Date.now()-typing.start)/1000);
            console.log(typingchart)
            typingchart.data.datasets[0].data.push((typing.type-typing.failed)/((Date.now()-typing.start)/1000));
            const len = 4;
            if (typingchart.data.labels.length>len) {
                console.log(Date.now()-typing.start,typingchart.data.labels[typingchart.data.labels.length-1-len]*1000)
                typingchart.data.datasets[1].data.push(len/((Date.now()-typing.start-typingchart.data.labels[typingchart.data.labels.length-1-len]*1000)/1000));
            }
            else {
                typingchart.data.datasets[1].data.push((typing.type-typing.failed)/((Date.now()-typing.start)/1000));
            }
            typingchart.update();
        }
        console.log(key,endline);
        if (endline) {
            typing.line++;
            TypeHistory.appendChild(typingline.getInputView());
            if (typing.lines.length>typing.line) {
                typingline = new Typing(typing.lines[typing.line],keyboard);
                if (typing.lines.length>typing.line+1) {
                    typingnextQues = new Typing(typing.lines[typing.line+1],keyboard).getQuesView();
                }
                else {
                    typingnextQues = elm("span",{},[textelm("end")]);
                }
            }
            else {
                status = "finish";
                Ques.replaceChildren(elm("span",{},[textelm("お疲れ様でした")]));
                Input.replaceChildren(elm("span",{},[textelm("スペースを押してタイトルへ")]));
                Next.replaceChildren(elm("span",{},[]));
            }
        }
    }
    else if (status=="finish") {
        if (e.key==" ") {
            init();
            status = "title";
        }
    }
    updateView();
},false);


</script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@200&display=swap');
</style>
<style>
    * {
        user-select: none;
        font-family: "Noto Sans JP", sans-serif;
        font-optical-sizing: auto;
        font-style: normal;
    }
    body {
        background-color: rgb(0, 2, 10);
        color: white;
        position: fixed;
        padding: 0;
        margin: 0;
        font-size: 30px;
    }
    #imgOutArea {
        height: 100%;
        width: 100%;
        overflow: auto;
        position: relative;
        padding: 0;
        margin: 0;
    }
    #imgOutArea>canvas {
        cursor: crosshair;
        touch-action: none;
        position: absolute;
        left: 10px;
        top: 10px;
        transform-origin: top left;
        background-color: rgba(255, 255, 255, 0.3);
    }
    #mainarea {
        height: 100dvh;
        width: 100dvw;
    }
    
    #playArea {
        font-size: 40px;
        & #Ques {
            & rt {
                font-size: 30px;
                color: rgb(255, 255, 255);
                & .s1 {
                    color: rgb(255, 255, 255);
                }
                & .s2 {
                    color: rgb(255, 173, 173);
                }
                & .s3 {
                    color: rgb(164, 164, 255);
                }
                & .s4 {
                    color: rgb(255, 132, 132);
                }
            }
            & rb, & .noruby {
                font-size: 70px;
                color: rgb(255, 255, 255);
                &.s1 {
                    color: rgb(255, 255, 255);
                }
                &.s2 {
                    color: rgb(255, 173, 173);
                }
                &.s3 {
                    color: rgb(164, 164, 255);
                }
                &.s4 {
                    color: rgb(255, 132, 132);
                }
            }
        }
        & #Input>span>span {
            font-size: 70px;
            color: rgb(255, 255, 255);
            &.s3 {
                color: rgb(164, 164, 255);
            }
            &.s4 {
                color: rgb(255, 132, 132);
            }
        }
    }
    
    #playArea {
        position: relative;
        height: 100%;
        &>div#Title {
            font-size: 60px;
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
        }
        &>div#Ques {
            position: absolute;
            top: calc(50% - 50.5px + 5% - 2% - 70px);
            left: 40px;
            width: max-content;
        }
        &>div#Input {
            position: absolute;
            top: calc(50% - 50.5px + 5% + 70px);
            left: 40px;
            width: max-content;
        }
        &>div#Next {
            position: absolute;
            right: 40px;
            bottom: 10px;
            width: max-content;
            & rt {
                font-size: 20px;
            }
            & rb, & .noruby {
                font-size: 40px;
            }
        }
    }

    #TypeHistory {
        &>span {
            display: block;
        }
        span {
            font-size: 35px;
            color: rgb(255, 255, 255);
            &.s3 {
                color: rgb(164, 164, 255);
            }
            &.s4 {
                color: rgb(255, 132, 132);
            }
        }
    }
</style>